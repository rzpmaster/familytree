name: Pre-release

on:
  workflow_call:
    inputs:
      version:
        description: "Release tag, e.g. v0.1.0-rc.1"
        required: true
        type: string
      prerelease:
        description: "Create as prerelease?"
        required: true
        default: true
        type: boolean
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag, e.g. v0.1.0-rc.1"
        required: true
        type: string
      prerelease:
        description: "Create as prerelease?"
        required: true
        default: true
        type: boolean
  push:
    tags:
      - "v*.*.*-rc.*"
      - "v*.*.*-beta.*"
      - "v*.*.*-alpha.*"

permissions:
  contents: write

concurrency:
  group: prerelease-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-prerelease:
    runs-on: ubuntu-latest

    env:
      FRONTEND_DIR: frontend
      BACKEND_DIR: backend
      SCRIPTS_DIR: scripts
      DIST_NAME: dist

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve tag/version
        id: ver
        shell: bash
        run: |
          set -e
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.version }}"
          else
            # refs/tags/v1.2.3-rc.1
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # ---- Frontend build (Vite/React) ----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install frontend deps
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Build frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run build

      # ---- Backend packaging (Python source + requirements) ----
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Prepare release bundle
        shell: bash
        run: |
          set -e
          mkdir -p release_bundle

          # 1) frontend dist
          if [[ ! -d "${{ env.FRONTEND_DIR }}/${{ env.DIST_NAME }}" ]]; then
            echo "Frontend dist not found: ${{ env.FRONTEND_DIR }}/${{ env.DIST_NAME }}"
            exit 1
          fi
          mkdir -p release_bundle/frontend
          cp -r "${{ env.FRONTEND_DIR }}/${{ env.DIST_NAME }}" "release_bundle/frontend/${{ env.DIST_NAME }}"

          # 2) backend source
          if [[ ! -d "${{ env.BACKEND_DIR }}" ]]; then
            echo "Backend dir not found: ${{ env.BACKEND_DIR }}"
            exit 1
          fi
          mkdir -p release_bundle/backend
          rsync -a --exclude="__pycache__" --exclude=".venv" --exclude=".pytest_cache" --exclude=".mypy_cache" \
            "${{ env.BACKEND_DIR }}/" "release_bundle/backend/"

          # 3) scripts
          if [[ -d "${{ env.SCRIPTS_DIR }}" ]]; then
            mkdir -p release_bundle/scripts
            rsync -a "${{ env.SCRIPTS_DIR }}/" "release_bundle/scripts/"
          fi
          # copy nginx.conf
          SRC_NGINX_TEMPLATE="${{ env.FRONTEND_DIR }}/nginx.conf.template"
          if [[ -f "$SRC_NGINX_TEMPLATE" ]]; then
            cp "$SRC_NGINX_TEMPLATE" "release_bundle/scripts/nginx.conf.template"
            echo "Copied $SRC_NGINX_TEMPLATE -> release_bundle/scripts/nginx.conf.template"
          else
            echo "WARNING: nginx.conf.template not found: $SRC_NGINX_TEMPLATE (skipped)"
          fi

          # 4) include README if exists
          files=(
            "README.md"
          )
          for file in "${files[@]}"; do
            if [[ -f "$file" ]]; then
              cp "$file" release_bundle/
              echo "Copied $file to release_bundle/"
            fi
          done

          # 5) create zip
          ZIP="familytree-${{ steps.ver.outputs.tag }}.zip"
          (cd release_bundle && zip -r "../${ZIP}" .)
          echo "zip=${ZIP}" >> $GITHUB_ENV

      - name: Generate release notes (simple)
        id: notes
        shell: bash
        run: |
          set -e
          TAG="${{ steps.ver.outputs.tag }}"
          # Try to generate notes from commits (best-effort)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "Build: ${TAG}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "包含：" >> $GITHUB_OUTPUT
          echo "- frontend/dist（前端静态文件）" >> $GITHUB_OUTPUT
          echo "- backend（后端源码 + requirements 等）" >> $GITHUB_OUTPUT
          echo "- scripts（Windows 启动脚本，如 start-all.bat）" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub pre-release (and upload asset)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          prerelease: ${{ github.event_name == 'workflow_dispatch' && inputs.prerelease || true }}
          generate_release_notes: true
          body: ${{ steps.notes.outputs.notes }}
          files: |
            ${{ env.zip }}
