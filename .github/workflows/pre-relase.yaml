name: Tag -> Pre-release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

concurrency:
  group: prerelease
  cancel-in-progress: false

jobs:
  # =========================
  # Meta: generate rc tag
  # =========================
  meta:
    runs-on: ubuntu-latest
    outputs:
      rc_tag: ${{ steps.meta.outputs.rc_tag }}
      base_tag: ${{ steps.meta.outputs.base_tag }}
      build_ref: ${{ steps.meta.outputs.build_ref }}

    steps:
      - id: meta
        shell: bash
        run: |
          set -e

          raw_tag="${GITHUB_REF_NAME}"

          # 1️⃣ 防御：rc tag 不应该触发 prerelease
          if [[ "$raw_tag" == *"-rc."* ]]; then
            echo "ERROR: RC tag '$raw_tag' should not trigger prerelease workflow." >&2
            exit 1
          fi

          # 2️⃣ 基础版本校验（vX.Y.Z）
          if ! [[ "$raw_tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Invalid tag format '$raw_tag'. Expected vX.Y.Z" >&2
            exit 1
          fi

          base="$raw_tag"

          # 3️⃣ build_ref 一定是这个 tag
          build_ref="$raw_tag"

          # 4️⃣ 判断远端 tag 是否存在
          tag_exists() {
            local tag="$1"
            git ls-remote --tags \
              "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" \
              "refs/tags/${tag}" | grep -q .
          }

          # 5️⃣ rc 永远从 rc.1 开始递增
          i=1
          while true; do
            candidate="${base}-rc.${i}"
            if ! tag_exists "$candidate"; then
              rc="$candidate"
              break
            fi
            i=$((i + 1))
            if [[ $i -gt 9999 ]]; then
              echo "ERROR: too many rc tags for ${base}" >&2
              exit 1
            fi
          done

          echo "base_tag=$base" >> "$GITHUB_OUTPUT"
          echo "rc_tag=$rc" >> "$GITHUB_OUTPUT"
          echo "build_ref=$build_ref" >> "$GITHUB_OUTPUT"

  # =========================
  # Build artifacts
  # =========================
  build:
    needs: meta
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.sha.outputs.commit_sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.meta.outputs.build_ref }}
          fetch-depth: 0

      - name: Resolve commit sha
        id: sha
        run: echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend and build
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Pack release artifacts
        run: |
          mkdir -p artifacts
          tar -czf artifacts/frontend-dist.tar.gz -C frontend dist
          tar -czf artifacts/backend-src.tar.gz \
            --exclude=backend/.venv \
            --exclude=backend/__pycache__ \
            --exclude=backend/.ruff_cache \
            --exclude=backend/.pytest_cache \
            --exclude=backend/.mypy_cache \
            -C . backend

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: artifacts/*

  # =========================
  # Create GitHub pre-release
  # =========================
  release:
    needs: [meta, build]
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: artifacts

      - name: Create GitHub Pre-release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          tag_name: ${{ needs.meta.outputs.rc_tag }}
          target_commitish: ${{ needs.build.outputs.commit_sha }}
          prerelease: true
          generate_release_notes: true
          files: |
            artifacts/frontend-dist.tar.gz
            artifacts/backend-src.tar.gz

  # =========================
  # Docker (rc only, no latest)
  # =========================
  docker:
    needs: [meta, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.meta.outputs.build_ref }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx (docker-container)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Docker meta (backend)
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=raw,value=${{ needs.meta.outputs.rc_tag }}

      - name: Docker meta (frontend)
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=raw,value=${{ needs.meta.outputs.rc_tag }}

      - name: Build & push backend (rc)
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta_backend.outputs.tags }}
          labels: ${{ steps.meta_backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push frontend (rc)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta_frontend.outputs.tags }}
          labels: ${{ steps.meta_frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
