name: Promote Release

on:
  workflow_dispatch:
    inputs:
      from_tag:
        description: "Pre-release tag to promote from, e.g. v0.2.0-rc.1"
        required: true
        type: string
      make_latest:
        description: "Mark final release/image as latest?"
        required: true
        default: true
        type: boolean
      keep_prerelease:
        description: "Keep the source release as prerelease (true) or convert it to draft (false)?"
        required: true
        default: true
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  promote:
    runs-on: ubuntu-latest
    env:
      FRONTEND_DIR: frontend
      BACKEND_DIR: backend

    steps:
      - name: Checkout (for git tag push)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tags (auto to_tag)
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          FROM="${{ inputs.from_tag }}"
          TO="${FROM%%-*}"   # 截取 '-' 之前
          if [[ "$TO" == "$FROM" ]]; then
            echo "ERROR: from_tag has no '-' part, expected like v0.2.0-rc.1"
            exit 1
          fi
          echo "from_tag=$FROM" >> "$GITHUB_OUTPUT"
          echo "to_tag=$TO" >> "$GITHUB_OUTPUT"

      - name: Validate source release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM: ${{ steps.ver.outputs.from_tag }}
        run: |
          set -e
          gh release view "$FROM" >/dev/null
          echo "Source release $FROM found."

      - name: Create final tag (points to same commit as from_tag)
        id: tag
        env:
          FROM: ${{ steps.ver.outputs.from_tag }}
          TO: ${{ steps.ver.outputs.to_tag }}
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          SHA="$(git rev-list -n 1 "$FROM")"

          if git show-ref --tags --verify --quiet "refs/tags/$TO"; then
            EXIST_SHA="$(git rev-list -n 1 "$TO")"
            if [[ "$EXIST_SHA" != "$SHA" ]]; then
              echo "ERROR: $TO points to $EXIST_SHA, but $FROM points to $SHA. Refusing to overwrite."
              exit 1
            fi
            echo "Tag $TO already exists and matches commit."
            echo "tag_created=false" >> "$GITHUB_OUTPUT"
          else
            git tag "$TO" "$SHA"
            git push origin "refs/tags/$TO"
            echo "Created and pushed tag $TO -> $SHA"
            echo "tag_created=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build release notes from previous published release to current commit
        id: notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM: ${{ steps.ver.outputs.from_tag }}
          TO: ${{ steps.ver.outputs.to_tag }}
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force

          # 当前这次 promote 的目标 commit（以 rc tag 指向为准）
          TO_SHA="$(git rev-list -n 1 "$FROM")"

          # 1) 找到“最近一个正式 release”（非 draft、非 prerelease）
          #    注意：过滤掉本次要创建/更新的 TO（避免把自己当成 previous）
          PREV_RELEASE_TAG="$(
            gh release list --limit 50 \
              --json tagName,isDraft,isPrerelease,createdAt,publishedAt \
              -q '.[] 
                  | select(.isDraft==false and .isPrerelease==false) 
                  | .tagName' \
            | grep -vx "$TO" \
            | head -n 1 || true
          )"

          if [[ -z "${PREV_RELEASE_TAG:-}" ]]; then
            echo "No previous published release found. Treat as initial release."
            PREV_SHA=""
            RANGE_TITLE="Initial release"
          else
            # 2) 上一个正式 release tag 对应的 commit
            PREV_SHA="$(git rev-list -n 1 "$PREV_RELEASE_TAG")"
            RANGE_TITLE="${PREV_RELEASE_TAG} → ${TO}"
          fi

          # 3) 生成变更列表：从 PREV_SHA 到 TO_SHA
          if [[ -z "${PREV_SHA:-}" ]]; then
            CHANGELOG="$(git log "$TO_SHA" --no-merges --pretty=format:'- %s (%h)')"
          else
            CHANGELOG="$(git log "${PREV_SHA}..${TO_SHA}" --no-merges --pretty=format:'- %s (%h)')"
          fi

          if [[ -z "${CHANGELOG:-}" ]]; then
            CHANGELOG="- No changes detected."
          fi

          # 4) 最终 release 标题固定为 TO
          echo "title=$TO" >> "$GITHUB_OUTPUT"

          # 5) 多行 body（随机分隔符，避免 EOF 问题）
          DELIM="__GH_OUTPUT_$(date +%s%N)__"
          {
            echo "body<<$DELIM"
            echo "## Changes (${RANGE_TITLE})"
            echo ""
            printf '%s\n' "$CHANGELOG"
            echo ""
            echo "## Docker images"
            echo ""
            echo "- ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-frontend:${TO}"
            echo "- ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-backend:${TO}"
            echo "$DELIM"
          } >> "$GITHUB_OUTPUT"

      - name: Create/Update final release (non-draft, non-prerelease)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TO: ${{ steps.ver.outputs.to_tag }}
          TITLE: ${{ steps.notes.outputs.title }}
        run: |
          set -e
          if gh release view "$TO" >/dev/null 2>&1; then
            gh release edit "$TO" --title "$TITLE" --notes "${{ steps.notes.outputs.body }}" --draft=false --prerelease=false
          else
            gh release create "$TO" --title "$TITLE" --notes "${{ steps.notes.outputs.body }}" --draft=false --prerelease=false
          fi

      - name: Copy assets from source release to final release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM: ${{ steps.ver.outputs.from_tag }}
          TO: ${{ steps.ver.outputs.to_tag }}
        run: |
          set -euo pipefail
          mkdir -p _assets
          ASSETS="$(gh release view "$FROM" --json assets -q '.assets[].name' || true)"
          if [[ -z "$ASSETS" ]]; then
            echo "No assets found on $FROM, skip."
            exit 0
          fi

          echo "$ASSETS" | while IFS= read -r name; do
            [[ -z "$name" ]] && continue
            gh release download "$FROM" --pattern "$name" --dir _assets

            # If exists on TO, delete first (idempotent)
            EXIST="$(gh release view "$TO" --json assets -q ".assets[] | select(.name==\"$name\") | .id" || true)"
            if [[ -n "$EXIST" ]]; then
              gh release delete-asset "$TO" "$name" -y
            fi

            gh release upload "$TO" "_assets/$name" --clobber
          done

      # ---------------- Docker: login ----------------
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      # ---------------- Docker: build + push frontend ----------------
      - name: Docker meta (frontend)
        id: meta_fe
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-frontend
          tags: |
            type=raw,value=${{ steps.ver.outputs.to_tag }}
            type=raw,value=latest
            type=sha,format=short

      - name: Build & push frontend image (final)
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.FRONTEND_DIR }}
          file: ${{ env.FRONTEND_DIR }}/Dockerfile
          push: true
          tags: ${{ steps.meta_fe.outputs.tags }}
          labels: ${{ steps.meta_fe.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ---------------- Docker: build + push backend ----------------
      - name: Docker meta (backend)
        id: meta_be
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-backend
          tags: |
            type=raw,value=${{ steps.ver.outputs.to_tag }}
            type=raw,value=latest
            type=sha,format=short

      - name: Build & push backend image (final)
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.BACKEND_DIR }}
          file: ${{ env.BACKEND_DIR }}/Dockerfile
          push: true
          tags: ${{ steps.meta_be.outputs.tags }}
          labels: ${{ steps.meta_be.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ----------------- make release as last -----------------------
      - name: Ensure final release is published (not draft/prerelease)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TO: ${{ steps.ver.outputs.to_tag }}
        shell: bash
        run: |
          set -euo pipefail
          gh release edit "$TO" --draft=false --prerelease=false

      - name: Mark final release as latest (optional)
        if: ${{ inputs.make_latest }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TO: ${{ steps.ver.outputs.to_tag }}
        run: |
          set -euo pipefail
          gh release edit "$TO" --latest

      - name: Optionally convert source prerelease to draft
        if: ${{ !inputs.keep_prerelease }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM: ${{ steps.ver.outputs.from_tag }}
        run: |
          set -e
          gh release edit "$FROM" --draft=true
      # ----------------- faile roll back tag -------------------------
      - name: Rollback created tag on failure
        if: ${{ failure() && steps.tag.outputs.tag_created == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TO: ${{ steps.ver.outputs.to_tag }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Workflow failed. Rolling back tag: $TO"

          # 删除远端 tag（失败也不要让回滚 step 再失败）
          git push --delete origin "$TO" || true

          # 删除本地 tag（runner 本地）
          git tag -d "$TO" || true

          echo "Rollback done."
