name: Promote Release (create final tag + copy assets/notes)

on:
  workflow_dispatch:
    inputs:
      from_tag:
        description: "Pre-release tag to promote from, e.g. v0.2.0-rc.1"
        required: true
        type: string
      to_tag:
        description: "Final release tag to create/update, e.g. v0.2.0"
        required: true
        type: string
      make_latest:
        description: "Mark final release as latest?"
        required: true
        default: true
        type: boolean
      keep_prerelease:
        description: "Keep the source release as prerelease (true) or convert it to draft (false)?"
        required: true
        default: true
        type: boolean

permissions:
  contents: write

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for git tag push)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate source release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM: ${{ inputs.from_tag }}
        run: |
          set -e
          gh release view "$FROM" >/dev/null
          echo "Source release $FROM found."

      - name: Create final tag (points to same commit as from_tag)
        env:
          FROM: ${{ inputs.from_tag }}
          TO: ${{ inputs.to_tag }}
        run: |
          set -e

          git fetch --tags --force

          # Resolve commit SHA of from_tag
          SHA="$(git rev-list -n 1 "$FROM")"
          echo "from_tag=$FROM sha=$SHA"

          # If to_tag already exists, ensure it points to same commit
          if git show-ref --tags --verify --quiet "refs/tags/$TO"; then
            EXIST_SHA="$(git rev-list -n 1 "$TO")"
            echo "to_tag exists sha=$EXIST_SHA"
            if [[ "$EXIST_SHA" != "$SHA" ]]; then
              echo "ERROR: $TO points to $EXIST_SHA, but $FROM points to $SHA. Refusing to overwrite."
              exit 1
            fi
            echo "Tag $TO already exists and matches commit. Skip create."
          else
            git tag "$TO" "$SHA"
            git push origin "refs/tags/$TO"
            echo "Created and pushed tag $TO -> $SHA"
          fi

      - name: Read source release info (title/body)
        id: src
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FROM: ${{ inputs.from_tag }}
        run: |
          set -e

          # Title
          TITLE="$(gh release view "$FROM" --json name -q .name)"
          if [[ -z "$TITLE" || "$TITLE" == "null" ]]; then
            TITLE="$FROM"
          fi

          # Body
          BODY="$(gh release view "$FROM" --json body -q .body)"
          if [[ -z "$BODY" || "$BODY" == "null" ]]; then
            BODY=""
          fi

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

          # Multiline output for body
          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$BODY" >> "$GITHUB_OUTPUT"
          echo "" >> "$GITHUB_OUTPUT"
